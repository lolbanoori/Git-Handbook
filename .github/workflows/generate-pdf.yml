name: Build PDF Cheat Sheet

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Pandoc & LaTeX
        run: |
          sudo apt-get update
          # Install Pandoc and LaTeX basics
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-extra-utils texlive-latex-extra
          
          # Install ONLY the shared libraries needed for Chrome (DO NOT install chromium-browser)
          sudo apt-get install -y libgbm-dev libnss3 libxss1 libasound2t64 libatk-bridge2.0-0t64 libgtk-3-0t64

          # Install mermaid-filter globally
          npm install --global mermaid-filter

      - name: Combine Markdown Files
        run: |
          # Metadata MUST be first to generate the Title Page
          cat metadata.yaml \
              src/commands/01-basics.md \
              src/commands/02-branching-and-remote.md \
              src/workflows/team-ops-manual.md \
              src/workflows/merge-conflicts.md \
              src/workflows/pull-requests.md \
              src/workflows/code-reviews.md \
              src/concepts/sha1-integrity.md \
              src/concepts/glossary.md \
              > combined_cheat_sheet.md

      - name: Configure Puppeteer
        # We point to the pre-installed Google Chrome to avoid Snap issues
        run: |
          echo '{ "puppetArgs": { "args": ["--no-sandbox"], "executablePath": "/usr/bin/google-chrome" } }' > .mermaid-config.json

      - name: Generate PDF
        run: |
          pandoc combined_cheat_sheet.md \
            -o Git_Cheat_Sheet.pdf \
            --filter mermaid-filter \
            --toc \
            --toc-depth=2 \
            -V geometry:margin=1in \
            -V colorlinks=true \
            -V linkcolor=blue \
            -V urlcolor=blue \
            --variable mainfont="DejaVu Sans" \
            --pdf-engine=pdflatex
        env:
          MERMAID_FILTER_CONFIG: .mermaid-config.json

      - name: Upload PDF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Git-Cheat-Sheet-PDF
          path: Git_Cheat_Sheet.pdf
          retention-days: 90
