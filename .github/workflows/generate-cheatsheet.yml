name: Build Cheat Sheet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: |
          # 1. Install Pandoc and full LaTeX distribution
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-extra-utils texlive-latex-extra

          # 2. Install Google Chrome Stable manually (to avoid Snap issues)
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb

          # 3. Create a Wrapper Script to FORCE --no-sandbox
          # This acts as a proxy for Chrome, ensuring the flag is ALWAYS present
          echo '#!/bin/bash' > chrome_wrapper
          echo 'exec /usr/bin/google-chrome-stable --no-sandbox "$@"' >> chrome_wrapper
          chmod +x chrome_wrapper
          sudo mv chrome_wrapper /usr/bin/chrome-no-sandbox

      - name: Install mermaid-filter
        run: npm install --global mermaid-filter

      - name: Configure Mermaid Filter
        run: |
          # Configure mermaid-filter to use our custom sandboxed wrapper
          echo '{ "executablePath": "/usr/bin/chrome-no-sandbox" }' > .puppeteer.json

      - name: Build Cheat Sheet
        run: |
          # 1. Initialize source with Metadata
          cat cheatsheet_metadata.yaml > cheatsheet_source.md

          # 2. Add filtered "Basics" (Remove "Installation & GUIs")
          sed '/^## Installation & GUIs/,/^## Setup/{/^## Setup/!d;}' src/commands/basics.md > basics_filtered.md
          
          # 3. Filter out Mermaid blocks from all source files and append
          for f in basics_filtered.md src/commands/branching-and-remote.md; do
            sed '/^```mermaid/,/^```/d' "$f" >> cheatsheet_source.md
            echo -e "\n\n" >> cheatsheet_source.md
          done

          pandoc cheatsheet_source.md \
            -o Git_Cheat_Sheet.pdf \
            --filter mermaid-filter \
            -V colorlinks=true \
            --variable mainfont="DejaVu Sans" \
            --pdf-engine=pdflatex

      - name: Upload Cheat Sheet
        uses: actions/upload-artifact@v4
        with:
          name: git-cheat-sheet

      - name: Publish Cheat Sheet to Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "Git_Cheat_Sheet.pdf"
          tag: latest
          name: "Latest Build"
          body: "Auto-generated build from main branch."
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}
